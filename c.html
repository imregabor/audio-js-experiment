<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Drop a file here</title>
    <style>
        canvas {
            /* margin-left : 10px; */ /* Fit to scale */
            /* margin-bottom: 10px; */
        }
        svg {
            shape-rendering : crispEdges ; /* see http://stackoverflow.com/questions/15723314/xcharts-rendering-of-text-is-blurry */
        }
        .noaxispath path.domain {
            display : none; /* see https://bl.ocks.org/mbostock/1166403 */
        }
    </style>
  </head>
  <body>

      <script src='lib/jquery-3.1.0/jquery-3.1.0.min.js'></script>
      <script src='lib/fpsmeter-0.3.1/fpsmeter.js'></script>
      <script src='lib/audiodrop/AudioDrop.js'></script>
      <script src='lib/buffaudio/buffaudio.js'></script>
      <script src='lib/dat.gui-0.5.1/dat.gui.min.js'></script>
      <script src='lib/d3-4.2.1/d3.min.js'></script>
      <script type='text/javascript'>
        'use strict';


        /**
         * Create a display.
         *
         * @param parent Parent module
         * @param size Lights count
         */
        function lightsDisplay(parent, size) {
            var component = $('<div>', { style : 'display: flex; margin-bottom: 20px;' } );
            var inner =  $('<div>', { style : 'background-color: black; padding: 10px; display: flex;' } ).appendTo(component);
            component.appendTo(parent);

            var grad = d3.scaleLinear().domain([0.0, 1.0]).range(['#602020', '#FFFBE8']).clamp(true);

            var ret = {
                size : size,
                setSize : function(s) {
                    ret.size = s;
                    var l = []; for (var i = 0; i < ret.size; i++) { l.push(0.1); }
                    return ret.set(l)
                },
                set : function(l) {
                    if (l.length !== ret.size) {
                        throw new Error('Expected size ' + ret.size + ', got ' + l.length);
                    }
                    var sel = d3.select(inner[0]).selectAll('div').data(l);
                    sel.style('background-color', grad);
                    sel.enter()
                            .append('div')
                            .style('background-color', grad)
                            .style('margin', '10px')
                            .style('width', '20px')
                            .style('height', '20px');
                    sel.exit()
                            .remove();
                    return ret;
                }
            };

            var l = []; for (var i = 0; i < size; i++) { l.push(0.0); }

            ret.set(l)
            return ret;
        }



        function getAudioContext() {
            // From http://ianreah.com/2013/02/28/Real-time-analysis-of-streaming-audio-data-with-Web-Audio-API.html
            if (typeof AudioContext !== "undefined") {
                return new AudioContext();
            } else if (typeof webkitAudioContext !== "undefined") {
                return new webkitAudioContext();
            } else {
                throw new Error('No AudioContext available');
            }
        }
        var grad = [];
        for (var i = 0; i < 256; i++) {
            var h = Number(i).toString(16);
            while (h.length < 2) {
                h = '0' + h;
            }
            grad.push('#' + h + h + h);
        }

        function si(x) {
            if (x >= 1000) {
                return x / 1000 + ' k';
            } else {
                return x;
            }
        }

        function scrollingCanvas(parent, w, h) {
            var component = $('<div>');

            var title = $('<h4>', { text : 'Scrolling canvas' }).appendTo(component);
            var chartdiv = $('<div>', { style : 'position: relative;' }).appendTo(component); // will use absolute positions for scales
            var canvas = ($('<canvas>', { width : w, height : h, style : 'display: block; background-color: black ;' }).appendTo(chartdiv))[0];
            component.appendTo(parent);

            // X axis when specified
            var xsvg;
            var xsvgg;
            var xscale;
            var xaxis;

            // Y axis when specified
            var ysvg;
            var ysvgg;
            var yscale;
            var yaxis;

            // Vertical canvas based scale when specified
            var cvscale;
            var cvscalectx;




            canvas.width=w;
            canvas.height=h;

            var ctx = canvas.getContext("2d");

            var tempCanvas = document.createElement("canvas");
            tempCanvas.width=w
            tempCanvas.height=h

            var tempCtx = tempCanvas.getContext("2d");

            var ret = {
                w : w,
                h : h,

                cvscaleCtx : function() {
                    if (!cvscalectx) {
                        cvscale = ($('<canvas>', { width : 50, height : h, style : 'display: block; background-color: white ; position : absolute  ; top : 0px ; left : ' + w + 'px' }).prependTo(chartdiv))[0];
                        cvscale.width=50;
                        cvscale.height=h;
                        cvscalectx = cvscale.getContext("2d");
                    }
                    return cvscalectx;
                },

                xaxis : function(domain, range) {
                    if (!xsvg) {
                        xsvg = d3.select(chartdiv[0]).append('svg')
                                    .attr('width', w + 20)
                                    .attr('height', 20)
                                    .style('position', 'absolute')
                                    .style('left', '-10px')
                                    .style('top', h + 'px')
                                    .classed('noaxispath', true);
                        xscale = d3.scaleLinear();
                        xaxis = d3.axisBottom().scale(xscale).tickFormat(si);
                        xsvgg = xsvg.append('g');
                    }
                    var rangeToUse = range ? [10 + range[0], 10 + range[1]] : [10, w + 10];
                    xscale.domain(domain).range(rangeToUse);
                    xsvgg.transition().call(xaxis); // See https://gist.github.com/phoebebright/3098488
                    return ret;
                },
                yaxis : function(domain, range) {
                    if (!ysvg) {
                        ysvg = d3.select(chartdiv[0]).append('svg')
                                .attr('width', 100)
                                .attr('height', h + 20)

                                .style('position', 'absolute')
                                .style('left', w + 'px')
                                .style('top', '-10px')
                                .classed('noaxispath', true);
                        yscale = d3.scaleLinear();
                        yaxis = d3.axisRight().scale(yscale).tickFormat(si);
                        ysvgg = ysvg.append('g');
                    }
                    var rangeToUse = range ? [10 + range[0], 10 + range[1]] : [10, h + 10];
                    yscale.domain(domain).range(rangeToUse);
                    ysvgg.transition().call(yaxis); // See https://gist.github.com/phoebebright/3098488
                    return ret;
                },



                axisFromFftParams : function(axis, size, invert, samplerate, freqbincount, clip) {
                    var domain;
                    var range;
                    if (freqbincount <= size) {
                        // every bin fits to 1 px
                        domain = [0, samplerate / 2];
                        range = [0, Math.min(freqbincount, size)];

                    } else if (clip) {
                        // not all bin fits, but all are 1 px
                        domain = [0, size * samplerate / (2 * freqbincount), samplerate / 2];
                        range = [0, size];
                    } else {
                        // every bin goes but merged
                        var n = 1;
                        while (freqbincount > size * n) {
                            n *= 2;
                        }
                        // n bins are merged
                        domain = [0, samplerate / 2];
                        range = [0, freqbincount / n];

                    }
                    return axis(domain, invert ? [size -  range[0], size - range[1]] : range);
                },
                xaxisFromFftParams : function(samplerate, freqbincount, clip) {
                    return ret.axisFromFftParams(ret.xaxis, w, false, samplerate, freqbincount, clip);
                },
                yaxisFromFftParams : function(samplerate, freqbincount, clip) {
                    return ret.axisFromFftParams(ret.yaxis, h, true, samplerate, freqbincount, clip);
                },

                xaxisFromFps : function(fps) {
                    return ret.xaxis([-w / fps, 0]);
                },
                getContext2d : function() {
                    return ctx;
                },
                /**
                 * Step the canvas 1 px left but dont clear right row.
                 */
                step : function() {
                    tempCtx.drawImage(canvas, 0, 0, w, h);
                    // set translate on the canvas
                    ctx.translate(-1, 0);
                    // draw the copied image
                    ctx.drawImage(tempCanvas, 0, 0, w, h, 0, 0, w, h);

                    // reset the transformation matrix
                    ctx.setTransform(1, 0, 0, 1, 0, 0);

                    return ret;
                },
                /**
                 * Clear rightmost pixel column.
                 */
                cline : function() {
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(w - 1, 0, 1, h);

                    return ret;
                },
                /**
                 * Draw a bar value in the rightmost pixel column.
                 *
                 * @param p Value normalized to 0..1 range
                 */
                bar : function(p) {
                    ret.step();
                    ret.cline();
                    if (p >= 0.0 && p <= 1.0) {
                        ctx.fillStyle = '#008800';
                        ctx.fillRect(w - 1, h * (1 - p), 1, h * p);
                    }

                    return ret;
                },
                /**
                 * Draw a bar value and a dot value in the righmost pixel column.
                 *
                 * @param p Bar value normalized to 0..1 range
                 * @param d Dot value normalized to 0..1 range
                 * @param d2 Dot value normalized to 0..1 range
                 */
                barAndDot : function(p, d, d2) {
                    ret.bar(p);
                    if (d && d >= 0.0 && d <= 1.0) {
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(w - 1, h * (1 - d), 1, 1);
                    }
                    if (d2 && d2 >= 0.0 && d2 <= 1.0) {
                        ctx.fillStyle = '#aaaaaa';
                        ctx.fillRect(w - 1, h * (1 - d2), 1, 1);
                    }
                    return ret;
                },


                simpleSpectrum : function(frequencyData) {
                    var s = Math.min(frequencyData.length, w);
                    for (var i = 0; i < s; i++) {
                        var y = h - Math.round(h *frequencyData[i] / 255);
                        ctx.fillStyle = '#000000';
                        ctx.fillRect(i, 0, 1, y -1);
                        ctx.fillStyle = '#008800';
                        ctx.fillRect(i, y, 1, h - y);
                    }
                },

                /**
                 * Draw byte frequency data (spectrum) in the rightmost pixel column.
                 *
                 * @param frequencyData Uint8Array spectrum
                 * @param clip Clip highest bands or scale spectrum to fit in
                 */
                byteFreqData : function(frequencyData, clip) {
                    ret.step();
                    if (clip || frequencyData.length <= h) {
                        if (h > frequencyData.length) {
                            ctx.fillStyle = '#000000';
                            ctx.fillRect(w - 1, 0, 1, h - frequencyData.length + 1);
                        }
                        // iterate over the elements from the array
                        for (var i = 0; i < frequencyData.length && i < h; i++) {
                            // draw each pixel with the specific color
                            var value = frequencyData[i];
                            ctx.fillStyle = grad[value];

                            // draw the line at the right side of the canvas
                            ctx.fillRect(w - 1, h - i, 1, 1);
                        }
                    } else {
                        // collapse some bands
                        var a = 1; // number of samples to collapse

                        while (frequencyData.length > h * a) {
                            a *= 2;
                        }

                        var i = 0;
                        while (i < h) {
                            var value = 0;
                            for (var j = 0; j < a; j++) {
                                value += frequencyData[i * a + j];
                            }
                            value /= a;

                            ctx.fillStyle = grad[Math.floor(value)];
                            ctx.fillRect(w - 1, h - i, 1, 1);

                            i++;
                        }
                    }

                    return ret;
                },
                /**
                 * Update title.
                 */
                title : function(t) {
                    title.text(t);
                    return ret;
                }
            };
            return ret;

        }



        /**
         * Allocate bands to group.
         *
         * @param samplerate Audio sample rate
         * @param fftsize FFT size parameter, freq data is expected to be half
         * @param max frequency to represent
         * @param count number of final groups
         * @param a Frequency span ratio of last/first band
         */
        function alloc(samplerate, fftsize, maxfreq, count, a) {

            console.log('Samplerate ', samplerate, 'fftsize', fftsize, 'maxfreq', maxfreq, 'a', a);

            var exp = Math.pow(a, 1 / (count - 1));


            var targetbinct = Math.round(fftsize * maxfreq / samplerate);
            console.log('Target bin count:', targetbinct, 'exp', exp);

            var sizes = [];
            var totalct =0;
            var b = targetbinct / (1 - Math.pow(exp, count)) * (1 - exp);
            console.log('b', b);

            for (var i = 0; i < count; i++) {
                var gi = Math.round(b * Math.pow(exp, i));
                sizes.push(gi);
                totalct += gi;
            }

            console.log('After first allocation:', sizes);

            while (totalct < targetbinct) {
                for (var i = sizes.length - 1; i >= 0 && totalct < targetbinct; i--) {
                    totalct ++;
                    sizes[i] ++;
                }
            }

            console.log('After adjustments', sizes);
            return sizes;

        }


        $(function() {



            var meter = new FPSMeter(document.body, { left: 'auto', top : 'auto', right : '5px', bottom : '5px' });


            // See http://ianreah.com/2013/02/28/Real-time-analysis-of-streaming-audio-data-with-Web-Audio-API.html
            // and http://ianreah.com/js/Real-time-frequency-analysis-of-streaming-audio-data/main.js
            //
            // Also http://www.smartjava.org/content/exploring-html5-web-audio-visualizing-sound
            // and http://www.smartjava.org/examples/webaudio/example4.html

            // http://caniuse.com/#feat=audio-api
            // http://caniuse.com/#feat=requestanimationframe


            var audioContext = getAudioContext();
            var analyser = audioContext.createAnalyser();

            analyser.smoothingTimeConstant = 0;

            var frequencyData;
            var setFftSize = function(fftSize) {
                analyser.fftSize = fftSize;
                frequencyData = new Uint8Array(analyser.frequencyBinCount);
            }
            setFftSize(4096)

            analyser.connect(audioContext.destination);


            var buffaudio;

            AudioDrop({
                context : audioContext,
                elements : window.document.body,
                drop : function(buffer, file) {
                    console.log('New file dropped');
                    console.log('Buffer:', buffer, 'file:', file)
                    if (buffaudio) {
                        console.log('buffaudio already inited');
                        buffaudio.stop();
                        buffaudio.initNewBuffer(buffer);



                    } else {
                        console.log('Init buffaudio');
                        buffaudio = new BuffAudio(audioContext, buffer, analyser);

                        // Kick it off...
                        update();
                    }
                    buffaudio.play();
                }
            });







            console.log(audioContext.sampleRate);

            var vu = lightsDisplay(window.document.body, 32);

            var c = scrollingCanvas(window.document.body, 800, 512).title('Bottom part of main spectrum').xaxisFromFps(60).yaxis([0, 100]);
            var sss = scrollingCanvas(window.document.body, 1024, 80).title('Spectrum');
            var pss = scrollingCanvas(window.document.body, 1024, 80).title('Power spectrum');
            var pov = scrollingCanvas(window.document.body, 800, 80).title('Scaled total energy and relaxed max energy (x3)').xaxisFromFps(60);


            var ma = 0.0; // Total energy max
            var maLastSet = 0; // Last timestamp when total energy max set
            var mi = 0.0; // Total energy min
            var miLastSet = 0; // Last timestamp when total energy min was set


            var p = {
                draw_spectrum : true,
                fftsize : 4096,
                clip_high : true,
                vu_size : 32,
                vu_decay_r : 997,
                vu_sustain_t : 3000,
                vu_bin_exponent : 2,


                updateFftParams : function() {
                    setFftSize(p.fftsize);
                    p.updateSamplingParams();
                },

                updateSamplingParams : function() {
                    console.log('Sampling params: samplerate:', audioContext.sampleRate, 'freq bins:', analyser.frequencyBinCount, 'clip:', p.clip_high);
                    c.yaxisFromFftParams(audioContext.sampleRate, analyser.frequencyBinCount, p.clip_high);
                    sss.xaxisFromFftParams(audioContext.sampleRate, analyser.frequencyBinCount, p.clip_high);
                    pss.xaxisFromFftParams(audioContext.sampleRate, analyser.frequencyBinCount, p.clip_high);
                },

                updateVuSize : function() {
                    vu.setSize(p.vu_size);
                }
            }
            p.updateSamplingParams();

            var gui = new dat.GUI();

            gui.add(p, 'fftsize', [ 32, 64, 128, 256, 512, 1024, 2048, 4096, 8192, 16384, 32768, 65536]).onChange(p.updateFftParams);

            var spf = gui.addFolder('Spectrum display');
            spf.add(p, 'draw_spectrum');
            spf.add(p, 'clip_high').onChange(p.updateSamplingParams);
            spf.open();

            var vuf = gui.addFolder('VU Meter');
            vuf.add(p, 'vu_size').onChange(p.updateVuSize);
            vuf.add(p, 'vu_decay_r');
            vuf.add(p, 'vu_sustain_t');
            vuf.add(p, 'vu_bin_exponent', [1, 2]);
            vuf.open();





            var os = alloc(audioContext.sampleRate, p.fftsize, 3500, 24, 32);
            var osm = [];
            for (var i = 0; i < os.length; i++) { osm.push(0); }

            var x = c.cvscaleCtx();
            var s = 0;
            for (var i = 0; i < os.length; i++) {
                x.fillStyle = i % 2 == 0 ? '#d0d0d0' : '#c0c0c0';
                x.fillRect(0, c.h - s - os[i], 50, os[i]);
                s += os[i];
            }



            function update() {
                requestAnimationFrame(update);

                meter.tick();

                var ctims = Date.now();

                analyser.getByteFrequencyData(frequencyData);

                var d = 0;
                for (var i = 0; i < frequencyData.length; i++) {
                    var s = frequencyData[i] / 255;
                    var ss = s;
                    for (var j = 1; j < p.vu_bin_exponent; j++) {
                        ss *= s;
                    }
                    d += ss;
                }
                d /= frequencyData.length;

                if (ctims - maLastSet > p.vu_sustain_t) {
                    // wait 3 s before scaling down max
                    ma *= p.vu_decay_r / 1000;
                }
                if (ctims - miLastSet > p.vu_sustain_t) {
                    // wait 3 s before scaling up min
                    mi = 1 - ( 1 - mi) * p.vu_decay_r / 1000;
                }

                if ( d > ma ) { ma = d; maLastSet = ctims; }
                if ( d < mi ) { mi = d; miLastSet = ctims; }

                pov.barAndDot(ma <= 0 ? 0 : (d - mi)/(ma - mi), 3 * ma, 3 * mi);


                var sums = [];
                sums.push(frequencyData[0]);
                for(var i = 1; i < frequencyData.length; i++) {
                    var n = frequencyData[i] / 255;
                    for (var j = 2; j < 4 && i * j < frequencyData.length; j++) {
                        n *= frequencyData[i * j] / 255;
                    }
                    sums.push(n * 255);
                }



                var org = [];
                var k = 0;

                for (var i = 0; i < os.length; i++) {
                    var orgi = 0;
                    for (var j = 0; j < os[i]; j++) {
                        orgi += frequencyData[k] * frequencyData[k];
                        // orgi += sums[k] * sums[k];
                        k++;
                    }
                    orgi /= (255 * os[i]);
                    org.push(orgi);
                    osm[i] *= 0.997;
                    if (osm[i] < orgi) {
                       osm[i] = orgi;
                    }
                }


                var vudata = [];
                var pp = vu.size * (d - mi) / (ma - mi);
                for (var i = 0; i < vu.size; i++) {
                    var v = pp > 1.0 ? 1.0 : pp;
                    pp -= v;
                    vudata.push(v);
                }
                vu.set(vudata);




                var bs = $('.bulb');
                var pp = Math.floor(bs.length * 255 * d/ma);
                for (var i = 0; i < bs.length; i++) {
                    /*
                    var v = pp > 255 ? 255 : pp;
                    pp -= v;
                    */

                    var mv = 0;
                    for (var j = -2; j <= 2; j++) {
                        if (i + j < 0 || i + j >= bs.length) { continue; }
                        if (osm[i+j] > mv) { mv = osm[i + j]; }
                    }

                    // var v = Math.floor(255 * org[i] / osm[i]);
                    var v = Math.floor(255 * org[i] / mv);
                    $(bs[i]).css('background-color', grad[ v ]);
                }
                // $('#l1').css('background-color', grad[ Math.floor(d/ma) ]);
                // $('#l1').css('background-color', grad[ Math.floor(255 * d/ma) ]);


                if (p.draw_spectrum) {
                    c.byteFreqData(frequencyData, p.clip_high);
                    sss.simpleSpectrum(frequencyData);
                    pss.simpleSpectrum(sums);
                }




            }



        });

      </script>

    <div style='display: flex;'>

        <div id='svgh'></div>
        <div style='background-color: black; padding: 10px; display: flex;'>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>

            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>

            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
        </div>
    </div>

  </body>

</html>