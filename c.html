<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Drop a file here</title>
    <style>
        html {
            overflow-y:scroll; /* see http://stackoverflow.com/questions/1202425/making-the-main-scrollbar-always-visible */
        }
        canvas {
            /* margin-left : 10px; */ /* Fit to scale */
            /* margin-bottom: 10px; */
        }
        svg {
            shape-rendering : crispEdges ; /* see http://stackoverflow.com/questions/15723314/xcharts-rendering-of-text-is-blurry */
        }
        .noaxispath path.domain {
            display : none; /* see https://bl.ocks.org/mbostock/1166403 */
        }
    </style>
  </head>
  <body>


      <script src='lib/jquery-3.1.0/jquery-3.1.0.min.js' type='text/javascript'></script>
      <script src='lib/fpsmeter-0.3.1/fpsmeter.js' type='text/javascript'></script>
      <script src='lib/audiodrop/AudioDrop.js' type='text/javascript'></script>
      <script src='lib/buffaudio/buffaudio.js' type='text/javascript'></script>
      <script src='lib/dat.gui-0.5.1/dat.gui.min.js' type='text/javascript'></script>
      <script src='lib/d3-4.2.1/d3.min.js' type='text/javascript'></script>
      <script src='lib/ui.js' type='text/javascript'></script>
      <script type='text/javascript'>
        "use strict";



        function getAudioContext() {
            // From http://ianreah.com/2013/02/28/Real-time-analysis-of-streaming-audio-data-with-Web-Audio-API.html
            if (typeof AudioContext !== "undefined") {
                return new AudioContext();
            } else if (typeof webkitAudioContext !== "undefined") {
                return new webkitAudioContext();
            } else {
                throw new Error('No AudioContext available');
            }
        }
        var grad = [];
        for (var i = 0; i < 256; i++) {
            var h = Number(i).toString(16);
            while (h.length < 2) {
                h = '0' + h;
            }
            grad.push('#' + h + h + h);
        }

        function si(x) {
            if (x >= 1000) {
                return x / 1000 + ' k';
            } else {
                return x;
            }
        }



        /**
         * Allocate bands to group.
         *
         * @param samplerate Audio sample rate
         * @param fftsize FFT size parameter, freq data is expected to be half
         * @param max frequency to represent
         * @param count number of final groups
         * @param a Frequency span ratio of last/first band
         */
        function alloc(samplerate, fftsize, maxfreq, count, a) {

            console.log('Samplerate ', samplerate, 'fftsize', fftsize, 'maxfreq', maxfreq, 'a', a);

            var exp = Math.pow(a, 1 / (count - 1));


            var targetbinct = Math.round(fftsize * maxfreq / samplerate);
            console.log('Target bin count:', targetbinct, 'exp', exp);

            var sizes = [];
            var totalct =0;
            var b = targetbinct / (1 - Math.pow(exp, count)) * (1 - exp);
            console.log('b', b);

            for (var i = 0; i < count; i++) {
                var gi = Math.round(b * Math.pow(exp, i));
                sizes.push(gi);
                totalct += gi;
            }

            console.log('After first allocation:', sizes);

            while (totalct < targetbinct) {
                for (var i = sizes.length - 1; i >= 0 && totalct < targetbinct; i--) {
                    totalct ++;
                    sizes[i] ++;
                }
            }

            console.log('After adjustments', sizes);
            return sizes;

        }


        $(function() {



            var meter = new FPSMeter(document.body, { left: 'auto', top : 'auto', right : '5px', bottom : '5px' });


            // See http://ianreah.com/2013/02/28/Real-time-analysis-of-streaming-audio-data-with-Web-Audio-API.html
            // and http://ianreah.com/js/Real-time-frequency-analysis-of-streaming-audio-data/main.js
            //
            // Also http://www.smartjava.org/content/exploring-html5-web-audio-visualizing-sound
            // and http://www.smartjava.org/examples/webaudio/example4.html

            // http://caniuse.com/#feat=audio-api
            // http://caniuse.com/#feat=requestanimationframe


            var audioContext = getAudioContext();
            var analyser = audioContext.createAnalyser();

            analyser.smoothingTimeConstant = 0;

            var frequencyData;
            var setFftSize = function(fftSize) {
                analyser.fftSize = fftSize;
                frequencyData = new Uint8Array(analyser.frequencyBinCount);
            }
            setFftSize(4096)

            analyser.connect(audioContext.destination);


            var buffaudio;

            AudioDrop({
                context : audioContext,
                elements : window.document.body,
                drop : function(buffer, file) {
                    console.log('New file dropped');
                    console.log('Buffer:', buffer, 'file:', file)
                    if (buffaudio) {
                        console.log('buffaudio already inited');
                        buffaudio.stop();
                        buffaudio.initNewBuffer(buffer);



                    } else {
                        console.log('Init buffaudio');
                        buffaudio = new BuffAudio(audioContext, buffer, analyser);

                        // Kick it off...
                        update();
                    }
                    buffaudio.play();
                }
            });







            console.log(audioContext.sampleRate);

            var vu = lightsDisplay(window.document.body, 32);

            var c = scrollingCanvas(window.document.body, 800, 512).title('Bottom part of main spectrum').xaxisFromFps(60).yaxis([0, 100]);
            var sss = scrollingCanvas(window.document.body, 1024, 80).title('Spectrum');
            var pss = scrollingCanvas(window.document.body, 1024, 80).title('Power spectrum');
            var pov = scrollingCanvas(window.document.body, 800, 80).title('Scaled total energy and relaxed max energy (x3)').xaxisFromFps(60);


            var ma = 0.0; // Total energy max
            var maLastSet = 0; // Last timestamp when total energy max set
            var mi = 0.0; // Total energy min
            var miLastSet = 0; // Last timestamp when total energy min was set


            var p = {
                draw_spectrum : true,
                fftsize : 4096,
                clip_high : true,
                vu_size : 32,
                vu_br_range : 1.0,
                vu_scale_min : true,
                vu_decay_r : 997,
                vu_sustain_t : 3000,
                vu_bin_exponent : 2,


                updateFftParams : function() {
                    setFftSize(p.fftsize);
                    p.updateSamplingParams();
                },

                updateSamplingParams : function() {
                    console.log('Sampling params: samplerate:', audioContext.sampleRate, 'freq bins:', analyser.frequencyBinCount, 'clip:', p.clip_high);
                    c.yaxisFromFftParams(audioContext.sampleRate, analyser.frequencyBinCount, p.clip_high);
                    sss.xaxisFromFftParams(audioContext.sampleRate, analyser.frequencyBinCount, p.clip_high);
                    pss.xaxisFromFftParams(audioContext.sampleRate, analyser.frequencyBinCount, p.clip_high);
                },

                updateVuSize : function() {
                    vu.setSize(p.vu_size);
                }
            }
            p.updateSamplingParams();

            var gui = new dat.GUI();

            gui.add(p, 'fftsize', [ 32, 64, 128, 256, 512, 1024, 2048, 4096, 8192, 16384, 32768, 65536]).onChange(p.updateFftParams);

            var spf = gui.addFolder('Spectrum display');
            spf.add(p, 'draw_spectrum');
            spf.add(p, 'clip_high').onChange(p.updateSamplingParams);
            spf.open();

            var vuf = gui.addFolder('VU Meter');
            vuf.add(p, 'vu_size').min(1).max(256).step(1).onChange(p.updateVuSize);
            vuf.add(p, 'vu_br_range').min(0).max(1);
            vuf.add(p, 'vu_scale_min');
            vuf.add(p, 'vu_decay_r');
            vuf.add(p, 'vu_sustain_t');
            vuf.add(p, 'vu_bin_exponent', [1, 2]);
            vuf.open();





            var os = alloc(audioContext.sampleRate, p.fftsize, 3500, 24, 32);
            var osm = [];
            for (var i = 0; i < os.length; i++) { osm.push(0); }

            var x = c.cvscaleCtx();
            var s = 0;
            for (var i = 0; i < os.length; i++) {
                x.fillStyle = i % 2 == 0 ? '#d0d0d0' : '#c0c0c0';
                x.fillRect(0, c.h - s - os[i], 50, os[i]);
                s += os[i];
            }



            function update() {
                requestAnimationFrame(update);

                meter.tick();

                var ctims = Date.now();

                analyser.getByteFrequencyData(frequencyData);

                var d = 0;
                for (var i = 0; i < frequencyData.length; i++) {
                    var s = frequencyData[i] / 255;
                    var ss = s;
                    for (var j = 1; j < p.vu_bin_exponent; j++) {
                        ss *= s;
                    }
                    d += ss;
                }
                d /= frequencyData.length;

                if (ctims - maLastSet > p.vu_sustain_t) {
                    // wait 3 s before scaling down max
                    ma *= p.vu_decay_r / 1000;
                }
                if (ctims - miLastSet > p.vu_sustain_t) {
                    // wait 3 s before scaling up min
                    mi = 1 - ( 1 - mi) * p.vu_decay_r / 1000;
                }

                if ( d > ma ) { ma = d; maLastSet = ctims; }
                if ( d < mi ) { mi = d; miLastSet = ctims; }

                var vuv;
                if (p.vu_scale_min) {
                    vuv = ma <= mi ? 0 : (d - mi)/(ma - mi);
                } else {
                    vuv = ma <= 0 ? 0 : d /ma;
                }

                pov.barAndDot(vuv, 3 * ma, 3 * mi);


                var sums = [];
                sums.push(frequencyData[0]);
                for(var i = 1; i < frequencyData.length; i++) {
                    var n = frequencyData[i] / 255;
                    for (var j = 2; j < 4 && i * j < frequencyData.length; j++) {
                        n *= frequencyData[i * j] / 255;
                    }
                    sums.push(n * 255);
                }



                var org = [];
                var k = 0;

                for (var i = 0; i < os.length; i++) {
                    var orgi = 0;
                    for (var j = 0; j < os[i]; j++) {
                        orgi += frequencyData[k] * frequencyData[k];
                        // orgi += sums[k] * sums[k];
                        k++;
                    }
                    orgi /= (255 * os[i]);
                    org.push(orgi);
                    osm[i] *= 0.997;
                    if (osm[i] < orgi) {
                       osm[i] = orgi;
                    }
                }


                var vudata = [];

                var pp = vu.size * vuv;
                for (var i = 0; i < vu.size; i++) {
                    var v = pp > 1.0 ? 1.0 : pp;
                    pp -= v;
                    vudata.push(v * (p.vu_br_range * vuv + 1 - p.vu_br_range));
                }
                vu.set(vudata);




                var bs = $('.bulb');
                var pp = Math.floor(bs.length * 255 * d/ma);
                for (var i = 0; i < bs.length; i++) {
                    /*
                    var v = pp > 255 ? 255 : pp;
                    pp -= v;
                    */

                    var mv = 0;
                    for (var j = -2; j <= 2; j++) {
                        if (i + j < 0 || i + j >= bs.length) { continue; }
                        if (osm[i+j] > mv) { mv = osm[i + j]; }
                    }

                    // var v = Math.floor(255 * org[i] / osm[i]);
                    var v = Math.floor(255 * org[i] / mv);
                    $(bs[i]).css('background-color', grad[ v ]);
                }
                // $('#l1').css('background-color', grad[ Math.floor(d/ma) ]);
                // $('#l1').css('background-color', grad[ Math.floor(255 * d/ma) ]);


                if (p.draw_spectrum) {
                    c.byteFreqData(frequencyData, p.clip_high);
                    sss.simpleSpectrum(frequencyData);
                    pss.simpleSpectrum(sums);
                }




            }



        });

      </script>

    <div style='display: flex;'>

        <div id='svgh'></div>
        <div style='background-color: black; padding: 10px; display: flex;'>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>

            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>

            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
            <div class='bulb' style='margin: 10px; width: 20px; height: 20px; background-color: #602020;'></div>
        </div>
    </div>

  </body>

</html>