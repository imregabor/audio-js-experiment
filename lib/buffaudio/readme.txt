From https://github.com/eipark/buffaudio

Slightly modified, need some debug before contributing changes back.
